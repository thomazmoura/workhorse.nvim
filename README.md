# workhorse.nvim

A NeoVim plugin for editing Azure DevOps work items using an oil.nvim-style buffer interface. View and edit work items as a simple text buffer where each line represents a work item.

> **Note:** Most of the code in this project is generated by AI (primarily Claude Code).

## Features

- **Oil.nvim-style editing** - Work items displayed as editable text lines
- **Full CRUD operations** - Create, read, update, and soft-delete work items
- **Saved queries** - Browse and execute Azure DevOps saved queries via Telescope
- **State management** - Change work item states through a floating menu
- **Virtual text** - Work item states displayed as virtual text at end of lines
- **Confirmation dialog** - Review changes before applying to Azure DevOps
- **Side panels** - Edit work item description and tags in dedicated buffers
- **Tag-based coloring** - Color work item titles based on type and tags

## Requirements

- Neovim >= 0.9.0
- [plenary.nvim](https://github.com/nvim-lua/plenary.nvim)
- [telescope.nvim](https://github.com/nvim-telescope/telescope.nvim) (for query picker)
- Azure DevOps Server or Azure DevOps Services with a Personal Access Token (PAT)

## Installation

### lazy.nvim

```lua
{
  "thomazmoura/workhorse.nvim",
  dependencies = {
    "nvim-lua/plenary.nvim",
    "nvim-telescope/telescope.nvim",
  },
  config = function()
    require("workhorse").setup({
      project = "YourProject",
    })
  end,
}
```

### packer.nvim

```lua
use {
  "thomazmoura/workhorse.nvim",
  requires = {
    "nvim-lua/plenary.nvim",
    "nvim-telescope/telescope.nvim",
  },
  config = function()
    require("workhorse").setup({
      project = "YourProject",
    })
  end,
}
```

### vim-plug

```vim
Plug 'nvim-lua/plenary.nvim'
Plug 'nvim-telescope/telescope.nvim'
Plug 'thomazmoura/workhorse.nvim'

" In your init.lua or after/plugin:
lua require("workhorse").setup({ project = "YourProject" })
```

## Configuration

### Environment Variables

Set these environment variables for authentication:

```bash
export AZURE_DEVOPS_URL="https://dev.azure.com/your-organization"
# Or for Azure DevOps Server:
export AZURE_DEVOPS_URL="https://your-server/tfs/DefaultCollection"

export AZURE_DEVOPS_PAT="your-personal-access-token"
```

### Setup Options

```lua
require("workhorse").setup({
  -- Required: Azure DevOps project name
  project = "MyProject",

  -- Optional: Override environment variables
  server_url = nil,  -- Falls back to AZURE_DEVOPS_URL
  pat = nil,         -- Falls back to AZURE_DEVOPS_PAT

  -- Team name (required for board_column grouping mode)
  team = nil,  -- e.g., "MyProject Team"

  -- Grouping mode: "state" (default) or "board_column"
  -- "state" groups work items by their workflow state
  -- "board_column" groups by Kanban board column (requires team to be set)
  grouping_mode = "state",

  -- Board name for column configuration (used when grouping_mode = "board_column")
  -- Common values: "Stories" for User Story/Bug, "Epics" for Epic/Feature
  default_board = "Stories",

  -- Work item defaults
  default_work_item_type = "User Story",
  work_item_type_hierarchy = { "Epic", "Feature", "User Story", "Task" },  -- Types by tree level
  default_area_path = nil,       -- If set, skips area picker and uses this value
  default_iteration_path = nil,  -- Uses project root if nil

  -- State for soft delete
  deleted_state = "Removed",

  -- Available states per work item type (customize as needed)
  available_states = {
    ["Epic"] = { "New", "Active", "Resolved", "Closed", "Removed" },
    ["Feature"] = { "New", "Active", "Resolved", "Closed", "Removed" },
    ["User Story"] = { "New", "Active", "Resolved", "Closed", "Removed" },
    ["Bug"] = { "New", "Active", "Resolved", "Closed" },
    ["Task"] = { "New", "Active", "Closed" },
  },

  -- Board column colors (used when grouping_mode = "board_column")
  -- Keys are column names, values are highlight group names
  column_colors = {},

  -- Tag-based title colors (Work Item Type -> Tag -> Highlight Group)
  -- First matching tag wins for items with multiple tags
  tag_title_colors = {
    -- Example: Color Bug titles red if they have "Critical" tag
    -- ["Bug"] = {
    --   ["Critical"] = "DiagnosticError",
    --   ["Silly"] = "DiagnosticWarn",
    -- },
  },

  -- UI options
  confirm_changes = true,  -- Show confirmation dialog before saving

  -- Cache settings
  cache = {
    enabled = true,
    ttl = 300,  -- 5 minutes
  },
})
```

### Board Column Mode

To display work items grouped by Kanban board columns (instead of workflow states) with Stack Rank ordering:

```lua
require("workhorse").setup({
  project = "MyProject",
  team = "MyProject Team",        -- Required: your team name
  grouping_mode = "board_column", -- Group by board column
  default_board = "Stories",      -- Board name (Stories, Epics, Features)
})
```

In this mode:
- Work items are grouped by their Kanban board column
- Items within each column are sorted by Stack Rank (same order as the board)
- Moving items between sections changes their board column

## Usage

### Commands

| Command | Description |
|---------|-------------|
| `:Workhorse query` | Open Telescope picker to select a saved query |
| `:Workhorse query <id>` | Open a specific saved query by ID |
| `:Workhorse refresh` | Refresh current buffer from Azure DevOps |
| `:Workhorse state` | Change state of work item under cursor |

### Buffer Keymaps

When in a workhorse buffer (flat queries):

| Key | Action |
|-----|--------|
| `<CR>` | Toggle description and tags side panels for work item under cursor |
| `<leader><leader>` | Apply changes |
| `<leader>R` | Refresh buffer |
| `gw` | Open work item in browser |

When in a workhorse buffer (tree queries):

| Key | Action |
|-----|--------|
| `<CR>` | Toggle description and tags side panels for work item under cursor |
| `<leader>ws` | Open column/state selection menu |
| `<leader><leader>` | Apply changes |
| `<leader>R` | Refresh buffer |
| `gw` | Open work item in browser |

### Suggested Global Keymaps

```lua
vim.keymap.set("n", "<leader>wq", require("workhorse").pick_query, { desc = "Workhorse: Pick query" })
vim.keymap.set("n", "<leader>wr", require("workhorse").refresh, { desc = "Workhorse: Refresh" })
```

## Buffer Format

Work items are displayed as editable text lines:

```
#1234 | Implement user authentication  [Active]
#1235 | Fix login page styling         [New]
#1236 | Add password reset flow        [Resolved]
```

- **ID and Title**: `#1234 | Work item title`
- **State**: Shown as virtual text at end of line (e.g., `[Active]`)

### Editing Operations

| Action | How |
|--------|-----|
| **Edit title** | Modify the title text after the `\|`, then `:w` to save |
| **Create work item** | Add a new line with just the title (no `#id \|` prefix), then `:w` |
| **Delete work item** | Remove the line entirely, then `:w` (soft-delete: state changes to "Removed") |
| **Change state** | Press `<CR>` to open actions menu, select "Change state" |

## Tree Queries (Parent/Child)

Tree queries are detected automatically and rendered as an indented list (one level per configured `tree_indent`).

Example:

```
[Epic] #100 | Platform
> [Feature] #200 | Observability
> > [Story] #300 | Add metrics export
```

Notes:
- **Column display**: Board column is shown as virtual text at line end.
- **Change column**: Press `<leader>ws` on an item to select a new column.
- **Description/Tags**: Press `<CR>` on an item to open the description and tags side panels.
- **Create item**: Add a new line at the desired indentation level. The type is determined by:
  1. First, inferring from existing items at that level in the tree
  2. If no items exist at that level, using `work_item_type_hierarchy` config (e.g., level 0 = Epic, level 1 = Feature)
  3. The parent is automatically set to the item directly above with one less indentation level
- **Chained creation**: You can create multiple new items at increasing indentation levels - each will become a child of the one above
- **Reparent**: Move items up/down to sit under another parent (same indentation); changing indentation is blocked.
- **Delete**: Remove the line, then apply (soft-delete).

Indentation can be a single string or a list (up to four levels) in config:

```lua
require("workhorse").setup({
  tree_indent = { "└─", "──", "──", "──" },
  tree_indent_hl = "LspCodeLens",
})
```

## Side Panels (Description & Tags)

Press `<CR>` on any work item to open the description and tags side panels on the right:

```
┌────────────────┬─────────────────┐
│                │ ═══ Description ═══│
│   Work Items   │   Description text  │
│     Buffer     ├─────────────────┤
│                │ ═══ Tags ═══    │
│                │   Tag1          │
│                │   Tag2          │
└────────────────┴─────────────────┘
```

- **Description panel**: Edit the work item description (converted from HTML)
- **Tags panel**: Each tag on a separate line; add/remove tags by editing lines
- **Headers**: The `═══ Description ═══` and `═══ Tags ═══` headers are readonly
- **Toggle**: Press `<CR>` again on the same item to close the panels
- **Save**: Changes are saved when you apply changes with `<leader><leader>`

### Example Workflow

1. Run `:Workhorse query` to open the query picker
2. Select a saved query from Telescope
3. Work items appear in a buffer
4. Edit titles, add new lines, or delete lines
5. Press `:w` to save - a confirmation dialog shows pending changes
6. Press `y` to apply changes to Azure DevOps

## Lualine Integration

Workhorse can display your current work item in lualine's statusline.

### Setup

1. Set the environment variable with your query ID:

   ```bash
   export WORKHORSE_LUALINE_QUERY_ID="your-query-guid-here"
   ```

2. Add the workhorse component to your lualine configuration:

   ```lua
   require('lualine').setup({
     sections = {
       lualine_x = {
         { require('workhorse').lualine.get },
       },
     },
   })
   ```

3. (Optional) Configure the refresh interval in your workhorse setup:

   ```lua
   require('workhorse').setup({
     -- ... other options
     lualine = {
       refresh_interval = 60000,  -- 1 minute (default)
     },
   })
   ```

The statusline will show the first work item (sorted by Stack Rank) from your query as `#123 | Work item title`.

If no environment variable is set, the lualine component will not fetch any data.

## Creating a Personal Access Token

1. Go to Azure DevOps > User Settings > Personal Access Tokens
2. Click "New Token"
3. Set a name and expiration
4. Select scopes:
   - **Work Items**: Read & Write
   - **Project and Team**: Read (for queries)
5. Copy the token and set it as `AZURE_DEVOPS_PAT`

## License

MIT
